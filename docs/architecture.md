# Sider æ¶æ„æ–‡æ¡£ï¼ˆå®Œæ•´ç‰ˆï¼‰

æœ¬æ–‡æ¡£æè¿° Sider æœåŠ¡å‘ç°ç³»ç»Ÿçš„æ•´ä½“æ¶æ„ã€æ•°æ®æ¨¡å‹ã€æ ¸å¿ƒæœºåˆ¶ã€ä»£ç ç»„ç»‡ä¸æ¼”è¿›è·¯çº¿ã€‚å½“å‰ç‰ˆæœ¬å·²å®Œæˆ M2 é˜¶æ®µï¼Œå¼•å…¥äº† Raft å…±è¯†åè®®å’ŒæŒä¹…åŒ–èƒ½åŠ›ï¼Œå®ç°é«˜å¯ç”¨æœåŠ¡å‘ç°ã€‚

---

## ç›®å½•

1. [èƒŒæ™¯ä¸ç›®æ ‡](#1-èƒŒæ™¯ä¸ç›®æ ‡)
2. [æ€»ä½“æ¶æ„](#2-æ€»ä½“æ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#3-æ ¸å¿ƒç»„ä»¶è¯¦è§£)
4. [æ•°æ®æ¨¡å‹](#4-æ•°æ®æ¨¡å‹)
5. [ä¸€è‡´æ€§ä¸ç´¢å¼•æ¨¡å‹](#5-ä¸€è‡´æ€§ä¸ç´¢å¼•æ¨¡å‹)
6. [Raft é›†ç¾¤æ¶æ„](#6-raft-é›†ç¾¤æ¶æ„)
7. [å¥åº·æ£€æŸ¥æœºåˆ¶](#7-å¥åº·æ£€æŸ¥æœºåˆ¶)
8. [Watch ä¸é•¿è½®è¯¢](#8-watch-ä¸é•¿è½®è¯¢)
9. [HTTP API è®¾è®¡](#9-http-api-è®¾è®¡)
10. [ä»£ç ç»„ç»‡ç»“æ„](#10-ä»£ç ç»„ç»‡ç»“æ„)
11. [æ•°æ®æµä¸äº¤äº’](#11-æ•°æ®æµä¸äº¤äº’)
12. [å¹¶å‘ä¸é”ç­–ç•¥](#12-å¹¶å‘ä¸é”ç­–ç•¥)
13. [éƒ¨ç½²æ‹“æ‰‘](#13-éƒ¨ç½²æ‹“æ‰‘)
14. [å¯è§‚æµ‹æ€§](#14-å¯è§‚æµ‹æ€§)
15. [å®‰å…¨æœºåˆ¶](#15-å®‰å…¨æœºåˆ¶)
16. [æ€§èƒ½ä¸å¯æ‰©å±•æ€§](#16-æ€§èƒ½ä¸å¯æ‰©å±•æ€§)
17. [æµ‹è¯•ç­–ç•¥](#17-æµ‹è¯•ç­–ç•¥)
18. [è·¯çº¿å›¾](#18-è·¯çº¿å›¾)

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 è®¾è®¡ç›®æ ‡

Sider æ˜¯ä¸€ä¸ªå— Consul å¯å‘çš„è½»é‡çº§æœåŠ¡å‘ç°ç³»ç»Ÿï¼Œæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ï¼š

- **æœåŠ¡æ³¨å†Œä¸å‘ç°**ï¼šæœåŠ¡å®ä¾‹åŠ¨æ€æ³¨å†Œã€å¥åº·æ£€æŸ¥ã€å®æ—¶æŸ¥è¯¢
- **é«˜å¯ç”¨æ€§**ï¼šåŸºäº Raft çš„å¤šèŠ‚ç‚¹å¼ºä¸€è‡´æ€§ï¼Œå®¹å¿èŠ‚ç‚¹æ•…éšœ
- **å®æ—¶å˜æ›´é€šçŸ¥**ï¼šæ”¯æŒé•¿è½®è¯¢ï¼Œå®¢æˆ·ç«¯å¯è®¢é˜…æœåŠ¡å˜æ›´
- **å¥åº·æ£€æŸ¥**ï¼šTTLã€HTTPã€TCPã€å‘½ä»¤å¤šç§æ£€æŸ¥æ–¹å¼
- **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šåŸºäº Namespace çš„é€»è¾‘éš”ç¦»

### 1.2 é€‚ç”¨åœºæ™¯

- å¾®æœåŠ¡é›†ç¾¤å†…éƒ¨å¯»å€
- ç°åº¦å‘å¸ƒä¸å¤šç‰ˆæœ¬ç®¡ç†
- å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
- æœåŠ¡å¥åº·çŠ¶æ€ç›‘æ§

### 1.3 é‡Œç¨‹ç¢‘åˆ’åˆ†

- **M1ï¼ˆå·²å®Œæˆï¼‰**ï¼šå†…å­˜æ³¨å†Œè¡¨ã€HTTP APIã€Agentã€TTL å¥åº·æ£€æŸ¥ã€é•¿è½®è¯¢
- **M2ï¼ˆå½“å‰ï¼‰**ï¼šRaft å…±è¯†ã€æŒä¹…åŒ–ã€Leader é€‰ä¸¾ã€é›†ç¾¤ç®¡ç†ã€TTL è¿‡æœŸåˆ†å¸ƒå¼åŒ–
- **M3ï¼ˆè§„åˆ’ï¼‰**ï¼šDNS æ¥å£ã€ACL/mTLSã€CLI/UIã€Prometheus æŒ‡æ ‡
- **M4ï¼ˆè§„åˆ’ï¼‰**ï¼šè·¨æœºæˆ¿å¤åˆ¶ã€äº‹ä»¶èšåˆä¼˜åŒ–ã€å¤‡ä»½æ¢å¤

---

## 2. æ€»ä½“æ¶æ„

### 2.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Applications                      â”‚
â”‚                    (Service Consumers & Providers)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ HTTP API
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Sider Cluster (3-5 nodes)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Node 1     â”‚  â”‚   Node 2     â”‚  â”‚   Node 3     â”‚          â”‚
â”‚  â”‚  (Leader)    â”‚  â”‚  (Follower)  â”‚  â”‚  (Follower)  â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚ HTTP Server  â”‚  â”‚ HTTP Server  â”‚  â”‚ HTTP Server  â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚RaftRegistry  â”‚  â”‚RaftRegistry  â”‚  â”‚RaftRegistry  â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚   Raft FSM   â”‚â—„â”€â”¼â”€â”€â”€â”€Raftâ”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚   Raft FSM   â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  Protocol     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚MemoryRegistryâ”‚  â”‚               â”‚  â”‚MemoryRegistryâ”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚ BoltDB + WAL â”‚  â”‚ BoltDB + WAL â”‚  â”‚ BoltDB + WAL â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–²
                       â”‚ Register & Heartbeat
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Sider Agents                              â”‚
â”‚  (Deployed on each service host, managing local services)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶

- **sds-server**ï¼šæœåŠ¡ç«¯è¿›ç¨‹ï¼Œæ‰¿è½½ HTTP API å’Œ Raft èŠ‚ç‚¹
- **sds-agent**ï¼šè½»é‡çº§ Agentï¼Œéƒ¨ç½²åœ¨æœåŠ¡ä¸»æœºä¸Šï¼Œè´Ÿè´£æ³¨å†Œå’Œå¥åº·æ£€æŸ¥
- **RaftRegistry**ï¼šRaft å°è£…å±‚ï¼Œåè°ƒå†™å…¥å¤åˆ¶å’Œè¯»å–
- **MemoryRegistry**ï¼šå†…å­˜çŠ¶æ€æœºï¼Œç»´æŠ¤æœåŠ¡æ³¨å†Œè¡¨ã€æ£€æŸ¥çŠ¶æ€ã€ç´¢å¼•
- **Raft FSM**ï¼šRaft çŠ¶æ€æœºå®ç°ï¼Œå°†æ—¥å¿—å‘½ä»¤æ˜ å°„åˆ°å†…å­˜æ“ä½œ
- **HTTP Server**ï¼šæä¾› RESTful APIï¼Œæ”¯æŒé•¿è½®è¯¢

---

## 3. æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 3.1 sds-server

**èŒè´£**ï¼š
- æ¥æ”¶å®¢æˆ·ç«¯æ³¨å†Œ/æŸ¥è¯¢è¯·æ±‚
- ä½œä¸º Raft é›†ç¾¤çš„ä¸€ä¸ªèŠ‚ç‚¹å‚ä¸å…±è¯†
- ç»´æŠ¤æœåŠ¡æ³¨å†Œè¡¨çš„å†…å­˜å¿«ç…§
- æä¾› HTTP API å’Œé›†ç¾¤ç®¡ç†æ¥å£

**å¯åŠ¨å‚æ•°**ï¼š
```bash
sds-server \
  -http :8500 \              # HTTP API ç›‘å¬åœ°å€
  -raft-id node1 \           # Raft èŠ‚ç‚¹å”¯ä¸€ ID
  -raft-bind :8501 \         # Raft é€šä¿¡åœ°å€
  -raft-dir data/node1 \     # æ•°æ®ç›®å½•ï¼ˆWAL + å¿«ç…§ï¼‰
  -raft-bootstrap true       # æ˜¯å¦ä½œä¸ºå¼•å¯¼èŠ‚ç‚¹
```

**å†…éƒ¨æ¨¡å—**ï¼š
1. **HTTPServer**ï¼šå¤„ç†å®¢æˆ·ç«¯ HTTP è¯·æ±‚
2. **RaftRegistry**ï¼šå†™æ“ä½œæäº¤åˆ° Raftï¼Œè¯»æ“ä½œç›´æ¥è®¿é—®å†…å­˜
3. **raftFSM**ï¼šå®ç° Raft FSM æ¥å£ï¼Œå°†æ—¥å¿—åº”ç”¨åˆ°å†…å­˜çŠ¶æ€
4. **memoryRegistry**ï¼šå†…å­˜æ•°æ®ç»“æ„ï¼Œç»´æŠ¤æœåŠ¡å®ä¾‹ã€æ£€æŸ¥ã€ç´¢å¼•
5. **Cluster Manager**ï¼šå¤„ç†èŠ‚ç‚¹åŠ å…¥ã€é…ç½®å˜æ›´

### 3.2 sds-agent

**èŒè´£**ï¼š
- æ³¨å†Œæœ¬åœ°æœåŠ¡å®ä¾‹åˆ° Sider é›†ç¾¤
- æ‰§è¡Œå¥åº·æ£€æŸ¥ï¼ˆTTLã€HTTPã€TCPã€å‘½ä»¤ï¼‰
- å®šæœŸç»­çº¦ï¼ˆTTLï¼‰æˆ–ä¸ŠæŠ¥æ£€æŸ¥ç»“æœ
- ä¼˜é›…é€€å‡ºæ—¶è‡ªåŠ¨æ³¨é”€

**é…ç½®ç¤ºä¾‹**ï¼ˆexamples/agent.demo.jsonï¼‰ï¼š
```json
{
  "services": [
    {
      "name": "api-gateway",
      "id": "api-gateway-1",
      "address": "192.168.1.10",
      "port": 8080,
      "checks": [
        {
          "type": "ttl",
          "ttl": "15s"
        },
        {
          "type": "http",
          "path": "/health",
          "interval": "10s",
          "timeout": "3s"
        }
      ]
    }
  ]
}
```

### 3.3 RaftRegistry

**èŒè´£**ï¼šç»Ÿä¸€å†™å…¥å’Œè¯»å–çš„æ¥å£å±‚

**ä»£ç ä½ç½®**ï¼š`internal/registry/raftreg.go`

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```go
// å†™æ“ä½œ - é€šè¿‡ Raft å¤åˆ¶
RegisterInstance(inst, specs) -> (index, checkIDs, error)
DeregisterInstance(ns, svc, id) -> (index, error)
RenewTTL(checkID) -> (index, error)
ReportCheck(checkID, status, output) -> (index, error)

// è¯»æ“ä½œ - ç›´æ¥ä»å†…å­˜è¯»å–
ListHealthyInstances(ns, svc, opts) -> (instances, index, error)
ListServices(ns) -> (services, index, error)
WatchService(ns, svc, lastIndex) -> (index, <-chan struct{})
```

**è®¾è®¡è¦ç‚¹**ï¼š
- å†™æ“ä½œæ„å»º Raft å‘½ä»¤å¹¶æäº¤ï¼Œç­‰å¾…åº”ç”¨åè¿”å›ç»“æœ
- è¯»æ“ä½œç›´æ¥ä»å†…å­˜çŠ¶æ€æœºè¯»å–ï¼ˆå¼ºä¸€è‡´æ€§ï¼Œå› ä¸ºè¯»çš„æ˜¯ Leader çš„æœ€æ–°çŠ¶æ€ï¼‰
- ç»Ÿä¸€çš„å‘½ä»¤æäº¤æ–¹æ³• `applyCommand()`ï¼Œæ¶ˆé™¤é‡å¤ä»£ç 

### 3.4 raftFSM

**èŒè´£**ï¼šRaft çŠ¶æ€æœºå®ç°ï¼Œå°†æ—¥å¿—å‘½ä»¤è½¬æ¢ä¸ºå†…å­˜æ“ä½œ

**ä»£ç ä½ç½®**ï¼š`internal/registry/raftfsm.go`

**å®ç°çš„æ¥å£**ï¼š
```go
type FSM interface {
    Apply(log *raft.Log) interface{}         // åº”ç”¨æ—¥å¿—å‘½ä»¤
    Snapshot() (FSMSnapshot, error)          // åˆ›å»ºå¿«ç…§
    Restore(io.ReadCloser) error             // ä»å¿«ç…§æ¢å¤
}
```

**å‘½ä»¤å¤„ç†æµç¨‹**ï¼š
1. è§£æå‘½ä»¤å°è£…ï¼ˆcommandEnvelopeï¼‰
2. æ ¹æ®æ“ä½œç±»å‹åˆ†å‘åˆ°å¯¹åº”å¤„ç†å™¨
3. è°ƒç”¨ memoryRegistry çš„æ–¹æ³•æ‰§è¡Œæ“ä½œ
4. è¿”å›ç¼–ç åçš„å“åº”

**æ”¯æŒçš„å‘½ä»¤**ï¼š
- `register`ï¼šæ³¨å†ŒæœåŠ¡å®ä¾‹
- `deregister`ï¼šæ³¨é”€æœåŠ¡å®ä¾‹
- `renew_ttl`ï¼šç»­çº¦ TTL æ£€æŸ¥
- `report_check`ï¼šæŠ¥å‘Šå¥åº·æ£€æŸ¥ç»“æœ

### 3.5 memoryRegistry

**èŒè´£**ï¼šå†…å­˜æ•°æ®ç»“æ„ï¼Œç»´æŠ¤æ‰€æœ‰æœåŠ¡çŠ¶æ€

**ä»£ç ä½ç½®**ï¼š`internal/registry/memory.go`

**æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š
```go
type memoryRegistry struct {
    mu sync.RWMutex

    // æ ¸å¿ƒæ•°æ®
    instances map[string]*instanceRecord  // ns/svc/id -> å®ä¾‹
    checks    map[string]*checkRecord     // checkID -> æ£€æŸ¥

    // ç´¢å¼•ä¸æŸ¥è¯¢
    idToKeys  map[string][]string         // id -> [keys...]
    svcIndex  map[string]uint64           // ns/svc -> ç´¢å¼•
    watchers  map[string][]chan struct{}  // ns/svc -> é€šçŸ¥é€šé“

    // å…¨å±€çŠ¶æ€
    index          uint64
    stopCh         chan struct{}
    expirerStarted bool
}
```

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- è¯»å†™é”ä¿æŠ¤å¹¶å‘è®¿é—®
- å…¨å±€ç´¢å¼•å’ŒæœåŠ¡ç´¢å¼•åˆ†ç¦»ï¼Œæ”¯æŒç²¾ç¡®çš„å˜æ›´é€šçŸ¥
- TTL è¿‡æœŸå™¨ä»…åœ¨ Leader ä¸Šè¿è¡Œ
- Watchers é‡‡ç”¨è¾¹ç¼˜è§¦å‘ï¼Œé¿å… goroutine æ³„æ¼

---

## 4. æ•°æ®æ¨¡å‹

### 4.1 æ ¸å¿ƒç±»å‹

#### ServiceInstance
```go
type ServiceInstance struct {
    Namespace   string            // å‘½åç©ºé—´ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰
    Service     string            // æœåŠ¡å
    ID          string            // å®ä¾‹å”¯ä¸€æ ‡è¯†
    Address     string            // IP/åŸŸå
    Port        int               // ç«¯å£
    Tags        []string          // æ ‡ç­¾ï¼ˆç”¨äºè¿‡æ»¤ï¼‰
    Meta        map[string]string // å…ƒæ•°æ®ï¼ˆè‡ªå®šä¹‰é”®å€¼ï¼‰
    Weights     Weights           // è´Ÿè½½å‡è¡¡æƒé‡

    // å†…éƒ¨å­—æ®µ
    CreateIndex uint64            // åˆ›å»ºç´¢å¼•
    ModifyIndex uint64            // æœ€åä¿®æ”¹ç´¢å¼•
}
```

#### CheckSpec
```go
type CheckSpec struct {
    Type     CheckType     // ttl | http | tcp | cmd
    TTL      time.Duration // TTL æ£€æŸ¥çš„è¶…æ—¶æ—¶é—´
    HTTP     string        // HTTP æ£€æŸ¥çš„è·¯å¾„
    Interval time.Duration // æ£€æŸ¥é—´éš”
    Timeout  time.Duration // æ£€æŸ¥è¶…æ—¶
}
```

#### Check
```go
type Check struct {
    ID         string        // æ£€æŸ¥ IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    Spec       CheckSpec     // æ£€æŸ¥é…ç½®
    Status     CheckStatus   // passing | warning | critical | unknown
    Output     string        // æ£€æŸ¥è¾“å‡º
    LastUpdate time.Time     // æœ€åæ›´æ–°æ—¶é—´
    LastPass   time.Time     // æœ€åé€šè¿‡æ—¶é—´ï¼ˆTTLï¼‰
}
```

### 4.2 å¥åº·èšåˆè§„åˆ™

å®ä¾‹çš„å¥åº·çŠ¶æ€ç”±æ‰€æœ‰æ£€æŸ¥èšåˆè€Œæˆï¼Œé‡‡ç”¨"æœ€åä¼˜å…ˆ"ç­–ç•¥ï¼š

```
æ— æ£€æŸ¥         â†’ passing  ï¼ˆé»˜è®¤å¥åº·ï¼‰
æœ‰ critical    â†’ critical ï¼ˆä»»ä½•æ£€æŸ¥å¤±è´¥åˆ™å¤±è´¥ï¼‰
æœ‰ unknown     â†’ unknown  ï¼ˆæœªçŸ¥çŠ¶æ€ï¼‰
æœ‰ warning     â†’ warning  ï¼ˆå‘Šè­¦ä½†å¯ç”¨ï¼‰
å…¨ passing     â†’ passing  ï¼ˆå®Œå…¨å¥åº·ï¼‰
```

---

## 5. ä¸€è‡´æ€§ä¸ç´¢å¼•æ¨¡å‹

### 5.1 Raft å…±è¯†ä¿è¯

- **å†™å…¥çº¿æ€§åŒ–**ï¼šæ‰€æœ‰å†™æ“ä½œé€šè¿‡ Raft æ—¥å¿—å¤åˆ¶ï¼Œä¿è¯å…¨å±€é¡ºåº
- **å¤šæ•°æ´¾ç¡®è®¤**ï¼šå†™å…¥éœ€è¦è¶…è¿‡åŠæ•°èŠ‚ç‚¹ç¡®è®¤ï¼ˆ3 èŠ‚ç‚¹å®¹å¿ 1 æ•…éšœï¼Œ5 èŠ‚ç‚¹å®¹å¿ 2 æ•…éšœï¼‰
- **è‡ªåŠ¨é€‰ä¸»**ï¼šLeader å¤±æ•ˆåï¼ŒFollower è‡ªåŠ¨å‘èµ·é€‰ä¸¾ï¼ˆç§’çº§æ¢å¤ï¼‰

### 5.2 ç´¢å¼•æœºåˆ¶

#### å…¨å±€ç´¢å¼•ï¼ˆindexï¼‰
- æ¯æ¬¡å†™æ“ä½œè‡ªå¢
- ç”¨äºè¿½è¸ªå…¨å±€å˜æ›´é¡ºåº
- å®¢æˆ·ç«¯é€šè¿‡ `X-Index` å“åº”å¤´è·å–

#### æœåŠ¡ç´¢å¼•ï¼ˆsvcIndexï¼‰
- æ¯ä¸ªæœåŠ¡ç»´æŠ¤ç‹¬ç«‹ç´¢å¼•
- è®°å½•è¯¥æœåŠ¡æœ€åä¸€æ¬¡å˜æ›´çš„å…¨å±€ç´¢å¼•
- ç”¨äºç²¾ç¡®çš„å˜æ›´é€šçŸ¥å’Œé•¿è½®è¯¢

#### ç´¢å¼•æ¨è¿›æ—¶æœº
1. æ³¨å†Œå®ä¾‹
2. æ³¨é”€å®ä¾‹
3. ç»­çº¦ TTLï¼ˆæ£€æŸ¥çŠ¶æ€å˜æ›´ï¼‰
4. æŠ¥å‘Šæ£€æŸ¥ç»“æœ
5. TTL è¿‡æœŸï¼ˆä»… Leaderï¼‰

### 5.3 è¯»ä¸€è‡´æ€§

**å½“å‰å®ç°ï¼ˆM2ï¼‰**ï¼š
- æ‰€æœ‰è¯»æ“ä½œè®¿é—® Leader çš„å†…å­˜çŠ¶æ€
- ç­‰ä»·äºçº¿æ€§åŒ–è¯»ï¼ˆLinearizable Readï¼‰
- å®¢æˆ·ç«¯å§‹ç»ˆè¯»å–åˆ°æœ€æ–°å·²æäº¤çš„çŠ¶æ€

**æœªæ¥å¢å¼ºï¼ˆM3ï¼‰**ï¼š
- æ”¯æŒ `stale=true` å‚æ•°ï¼Œå…è®¸ Follower æä¾›é™ˆæ—§è¯»
- é™ä½ Leader è´Ÿè½½ï¼Œæé«˜è¯»ååé‡

---

## 6. Raft é›†ç¾¤æ¶æ„

### 6.1 èŠ‚ç‚¹è§’è‰²

- **Leader**ï¼šå¤„ç†æ‰€æœ‰å†™è¯·æ±‚ï¼Œå¤åˆ¶æ—¥å¿—åˆ° Follower
- **Follower**ï¼šæ¥æ”¶æ—¥å¿—å¤åˆ¶ï¼Œå‚ä¸é€‰ä¸¾æŠ•ç¥¨
- **Candidate**ï¼šé€‰ä¸¾æœŸé—´çš„ä¸´æ—¶çŠ¶æ€

### 6.2 æ•°æ®æŒä¹…åŒ–

æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸‰ç§å­˜å‚¨ï¼š

1. **StableStore**ï¼ˆraft-stable.dbï¼‰
   - å­˜å‚¨å½“å‰ä»»æœŸã€æŠ•ç¥¨è®°å½•
   - ä½¿ç”¨ BoltDB

2. **LogStore**ï¼ˆraft-log.dbï¼‰
   - å­˜å‚¨ Raft æ—¥å¿—æ¡ç›®ï¼ˆWALï¼‰
   - ä½¿ç”¨ BoltDB
   - æ”¯æŒæ—¥å¿—å‹ç¼©

3. **SnapshotStore**ï¼ˆç›®å½•ï¼‰
   - å­˜å‚¨çŠ¶æ€æœºå¿«ç…§
   - JSON æ ¼å¼å…¨é‡åºåˆ—åŒ–
   - ä¿ç•™æœ€è¿‘ 2 ä¸ªå¿«ç…§

### 6.3 å¿«ç…§ç­–ç•¥

**è§¦å‘æ¡ä»¶**ï¼ˆæ»¡è¶³ä»»ä¸€ï¼‰ï¼š
- æ—¶é—´é—´éš”ï¼š20 ç§’
- æ—¥å¿—æ¡ç›®æ•°ï¼š8192

**å¿«ç…§å†…å®¹**ï¼š
```json
{
  "instances": {...},  // æ‰€æœ‰æœåŠ¡å®ä¾‹
  "checks": {...},     // æ‰€æœ‰å¥åº·æ£€æŸ¥
  "id_to_keys": {...}, // ID ç´¢å¼•
  "svc_index": {...},  // æœåŠ¡ç´¢å¼•
  "index": 12345       // å…¨å±€ç´¢å¼•
}
```

**å¿«ç…§æ¢å¤**ï¼š
- èŠ‚ç‚¹é‡å¯åè‡ªåŠ¨åŠ è½½æœ€æ–°å¿«ç…§
- æ¢å¤å†…å­˜çŠ¶æ€ï¼Œæ¸…ç©º watchers
- ç»§ç»­æ¥æ”¶æ–°çš„æ—¥å¿—æ¡ç›®

### 6.4 é›†ç¾¤ç®¡ç†

#### å¼•å¯¼é›†ç¾¤ï¼ˆBootstrapï¼‰
```bash
# ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
sds-server -raft-id node1 -raft-bind :8501 -raft-bootstrap=true
```

#### åŠ å…¥é›†ç¾¤ï¼ˆJoinï¼‰
```bash
# å¯åŠ¨æ–°èŠ‚ç‚¹
sds-server -raft-id node2 -raft-bind :9501 -raft-bootstrap=false

# å‘ Leader å‘é€åŠ å…¥è¯·æ±‚
curl -X POST http://leader:8500/v1/raft/join \
  -H 'Content-Type: application/json' \
  -d '{"ID":"node2","Addr":"127.0.0.1:9501"}'
```

#### èŠ‚ç‚¹ç§»é™¤
```bash
# é€šè¿‡ Raft APIï¼ˆæœªæ¥å®ç°ï¼‰
curl -X POST http://leader:8500/v1/raft/remove \
  -d '{"ID":"node2"}'
```

---

## 7. å¥åº·æ£€æŸ¥æœºåˆ¶

### 7.1 TTL æ£€æŸ¥

**å·¥ä½œåŸç†**ï¼š
1. Agent æ³¨å†ŒæœåŠ¡æ—¶å£°æ˜ TTLï¼ˆå¦‚ `15s`ï¼‰
2. åˆå§‹çŠ¶æ€ä¸º `critical`ï¼ˆé¿å…æœªå°±ç»ªå³å¯¹å¤–å¯è§ï¼‰
3. Agent æ¯ `2/3 * TTL` ç»­çº¦ä¸€æ¬¡
4. Leader æ¯ç§’æ‰«æï¼Œè¶…æ—¶æœªç»­çº¦çš„æ£€æŸ¥æ ‡è®°ä¸º `critical`

**ç»­çº¦æ–¹å¼**ï¼š
```bash
PUT /v1/agent/check/pass/{check_id}
```

**ä¼˜åŠ¿**ï¼š
- ç®€å•é«˜æ•ˆï¼Œå®¢æˆ·ç«¯æ§åˆ¶èŠ‚å¥
- é€‚åˆå¿«é€Ÿå¿ƒè·³åœºæ™¯

### 7.2 HTTP æ£€æŸ¥

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "type": "http",
  "path": "/health",
  "interval": "10s",
  "timeout": "3s"
}
```

**å¥åº·åˆ¤å®š**ï¼š
- 2xx/3xx â†’ `passing`
- 4xx â†’ `warning`
- å…¶ä»–/è¶…æ—¶ â†’ `critical`

### 7.3 TCP æ£€æŸ¥

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "type": "tcp",
  "interval": "10s",
  "timeout": "3s"
}
```

**å¥åº·åˆ¤å®š**ï¼š
- è¿æ¥æˆåŠŸ â†’ `passing`
- è¿æ¥å¤±è´¥ â†’ `critical`

### 7.4 å‘½ä»¤æ£€æŸ¥

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "type": "cmd",
  "cmd": ["/usr/bin/check-app.sh"],
  "interval": "30s",
  "timeout": "10s"
}
```

**å¥åº·åˆ¤å®š**ï¼š
- é€€å‡ºç  0 â†’ `passing`
- é€€å‡ºç é 0 â†’ `critical`
- è¾“å‡ºä½œä¸º `Output` å­—æ®µ

---

## 8. Watch ä¸é•¿è½®è¯¢

### 8.1 è®¾è®¡ç›®æ ‡

- å®¢æˆ·ç«¯èƒ½å®æ—¶æ„ŸçŸ¥æœåŠ¡å˜æ›´ï¼Œæ— éœ€è½®è¯¢
- æ”¯æŒè¶…æ—¶æ§åˆ¶ï¼Œé¿å…æ— é™é˜»å¡
- é«˜æ•ˆçš„å†…å­˜ç®¡ç†ï¼Œé¿å… goroutine æ³„æ¼

### 8.2 å®ç°æœºåˆ¶

#### WatchService
```go
func WatchService(ns, service string, lastIndex uint64) (uint64, <-chan struct{})
```

**è¡Œä¸º**ï¼š
1. å¦‚æœ `svcIndex > lastIndex`ï¼Œç«‹å³è¿”å›å·²å…³é—­çš„é€šé“ï¼ˆè¾¹ç¼˜è§¦å‘ï¼‰
2. å¦åˆ™åˆ›å»ºå¸¦ç¼“å†²çš„é€šé“ï¼ŒåŠ å…¥ watchers åˆ—è¡¨
3. ä¸‹æ¬¡è¯¥æœåŠ¡å˜æ›´æ—¶ï¼Œç»Ÿä¸€å…³é—­æ‰€æœ‰é€šé“å¹¶æ¸…ç©ºåˆ—è¡¨

#### é•¿è½®è¯¢ä½¿ç”¨
```bash
GET /v1/health/service/api?ns=default&index=100&wait=30s
```

**æµç¨‹**ï¼š
1. è§£æ `index` å’Œ `wait` å‚æ•°
2. è°ƒç”¨ `WatchService()` æ³¨å†Œç›‘å¬
3. é˜»å¡ç­‰å¾…é€šé“æˆ–è¶…æ—¶
4. è¿”å›æœ€æ–°æœåŠ¡å®ä¾‹åˆ—è¡¨å’Œå½“å‰ç´¢å¼•

### 8.3 è¶…æ—¶å¤„ç†

- å®¢æˆ·ç«¯æŒ‡å®š `wait` æ—¶é•¿ï¼ˆå¦‚ `30s`ï¼‰
- æœåŠ¡ç«¯ä½¿ç”¨ `context.WithTimeout()` åŒ…è£…
- è¶…æ—¶åè¿”å›å½“å‰çŠ¶æ€ï¼ˆå³ä½¿æœªå˜æ›´ï¼‰
- å®¢æˆ·ç«¯æ ¹æ® `X-Index` åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´

---

## 9. HTTP API è®¾è®¡

### 9.1 API åˆ—è¡¨

| è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | å†™/è¯» |
|------|------|------|------|
| `/v1/agent/service/register` | PUT/POST | æ³¨å†ŒæœåŠ¡å®ä¾‹ | å†™ |
| `/v1/agent/service/deregister/{id}` | PUT/POST | æ³¨é”€æœåŠ¡å®ä¾‹ï¼ˆè·¯å¾„å¼ï¼‰ | å†™ |
| `/v1/agent/service/deregister` | PUT/POST | æ³¨é”€æœåŠ¡å®ä¾‹ï¼ˆJSONï¼‰ | å†™ |
| `/v1/agent/check/pass/{check_id}` | PUT/POST | æ ‡è®°æ£€æŸ¥é€šè¿‡/ç»­çº¦ TTL | å†™ |
| `/v1/agent/check/warn/{check_id}` | PUT/POST | æ ‡è®°æ£€æŸ¥å‘Šè­¦ | å†™ |
| `/v1/agent/check/fail/{check_id}` | PUT/POST | æ ‡è®°æ£€æŸ¥å¤±è´¥ | å†™ |
| `/v1/catalog/services` | GET | åˆ—å‡ºæ‰€æœ‰æœåŠ¡ | è¯» |
| `/v1/health/service/{name}` | GET | æŸ¥è¯¢å¥åº·å®ä¾‹ï¼ˆæ”¯æŒé•¿è½®è¯¢ï¼‰ | è¯» |
| `/v1/raft/join` | POST | åŠ å…¥ Raft é›†ç¾¤ | ç®¡ç† |

è¯¦ç»†æ¥å£æ–‡æ¡£è¯·å‚è§ `docs/api.md`

---

## 10. ä»£ç ç»„ç»‡ç»“æ„

### 10.1 ç›®å½•æ ‘

```
sider/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ sds-server/       # æœåŠ¡ç«¯å…¥å£
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ sds-agent/        # Agent å…¥å£
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ api/              # HTTP API å±‚
â”‚   â”‚   â”œâ”€â”€ http.go       # è·¯ç”±å’Œå¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ types.go      # è¯·æ±‚/å“åº”ç±»å‹
â”‚   â”œâ”€â”€ registry/         # æ³¨å†Œè¡¨æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ types.go      # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ registry.go   # Registry æ¥å£
â”‚   â”‚   â”œâ”€â”€ memory.go     # å†…å­˜å®ç°ï¼ˆ442 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ raftcmd.go    # Raft å‘½ä»¤å®šä¹‰ï¼ˆ181 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ raftreg.go    # RaftRegistry å°è£…ï¼ˆ135 è¡Œï¼‰
â”‚   â”‚   â””â”€â”€ raftfsm.go    # Raft FSM å®ç°ï¼ˆ238 è¡Œï¼‰
â”‚   â”œâ”€â”€ raft/             # Raft æŠ½è±¡ï¼ˆå·²å¼ƒç”¨ï¼‰
â”‚   â”‚   â””â”€â”€ node.go       # æœ¬åœ°æ¡©å®ç°
â”‚   â”œâ”€â”€ server/           # æœåŠ¡ç«¯è£…é…
â”‚   â”‚   â”œâ”€â”€ server.go     # ä¸»æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ cluster.go    # Raft é›†ç¾¤ç®¡ç†
â”‚   â””â”€â”€ agent/            # Agent å®ç°
â”‚       â””â”€â”€ agent.go
â”œâ”€â”€ docs/                 # æ–‡æ¡£
â”‚   â”œâ”€â”€ architecture.md   # æ¶æ„æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ api.md            # API æ–‡æ¡£
â”‚   â”œâ”€â”€ dev_guide.md      # å¼€å‘è€…æŒ‡å—
â”‚   â””â”€â”€ m2_design.md      # M2 è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ agent.demo.json   # Agent é…ç½®ç¤ºä¾‹
â”œâ”€â”€ Makefile
â”œâ”€â”€ go.mod
â””â”€â”€ README.md
```

### 10.2 æ¨¡å—èŒè´£

#### internal/registry - æ ¸å¿ƒæ³¨å†Œè¡¨

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ |
|------|------|------|
| `types.go` | 89 | æ•°æ®æ¨¡å‹å®šä¹‰ |
| `registry.go` | ~50 | Registry æ¥å£ |
| `memory.go` | 442 | å†…å­˜å­˜å‚¨ã€ç´¢å¼•ã€TTL è¿‡æœŸ |
| `raftcmd.go` | 181 | å‘½ä»¤æ„å»ºã€è§£æã€ç¼–è§£ç  |
| `raftreg.go` | 135 | Raft å°è£…ï¼Œå†™å…¥å¤åˆ¶ã€è¯»å–è½¬å‘ |
| `raftfsm.go` | 238 | FSM å®ç°ï¼Œå‘½ä»¤å¤„ç†ã€å¿«ç…§ |

**è®¾è®¡äº®ç‚¹**ï¼š
- å‘½ä»¤ä¸å“åº”ç±»å‹ç»Ÿä¸€ç®¡ç†ï¼ˆ`raftcmd.go`ï¼‰
- æ¶ˆé™¤é‡å¤ä»£ç ï¼Œæå–é€šç”¨æ–¹æ³•
- æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œä¾¿äºæµ‹è¯•

#### internal/api - HTTP æ¥å£å±‚

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ |
|------|------|------|
| `http.go` | 304 | è·¯ç”±ã€å¤„ç†å™¨ã€é•¿è½®è¯¢ |
| `types.go` | ~100 | è¯·æ±‚/å“åº”ç±»å‹ |

**è®¾è®¡äº®ç‚¹**ï¼š
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
- ä¼˜é›…å…³é—­æ”¯æŒ

#### internal/server - æœåŠ¡ç«¯è£…é…

| æ–‡ä»¶ | è¡Œæ•° | èŒè´£ |
|------|------|------|
| `server.go` | 68 | ç»„è£…ç»„ä»¶ã€å¯åŠ¨æœåŠ¡ |
| `cluster.go` | 71 | Raft é›†ç¾¤ç®¡ç†ã€èŠ‚ç‚¹åŠ å…¥ |

**è®¾è®¡äº®ç‚¹**ï¼š
- ç›‘å¬ Leader å˜æ›´ï¼ŒåŠ¨æ€å¯åœ TTL è¿‡æœŸå™¨
- é›†ç¾¤åŠ å…¥æ¥å£å®ç°

---

## 11. æ•°æ®æµä¸äº¤äº’

### 11.1 å†™æ“ä½œæµç¨‹ï¼ˆæ³¨å†Œå®ä¾‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ PUT /v1/agent/service/register (JSON)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTP Server      â”‚
â”‚ handleRegister()   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ Reg.RegisterInstance()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RaftRegistry      â”‚
â”‚ RegisterInstance() â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 1. BuildRegisterCommand()  # æ„å»ºå‘½ä»¤
     â”‚ 2. applyCommand()          # æäº¤åˆ° Raft
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  hashicorp/raft    â”‚
â”‚ Apply(cmdData)     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ å¤åˆ¶åˆ°å¤šæ•°æ´¾èŠ‚ç‚¹
     â”‚ åº”ç”¨åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ FSM
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   raftFSM          â”‚
â”‚ Apply()            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 1. è§£æå‘½ä»¤å°è£…
     â”‚ 2. applyRegister()         # åˆ†å‘åˆ°å¤„ç†å™¨
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  memoryRegistry    â”‚
â”‚ RegisterInstance() â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 1. å†™å…¥ instances
     â”‚ 2. åˆ›å»º checks
     â”‚ 3. æ¨è¿›ç´¢å¼•
     â”‚ 4. å”¤é†’ watchers
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è¿”å›å“åº”         â”‚
â”‚ index, checkIDs    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 è¯»æ“ä½œæµç¨‹ï¼ˆæŸ¥è¯¢å¥åº·å®ä¾‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ GET /v1/health/service/api?passing=1&index=100&wait=30s
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTP Server      â”‚
â”‚ handleHealthServiceâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 1. è§£æå‚æ•°
     â”‚ 2. WatchService(ns, svc, lastIndex)  # æ³¨å†Œç›‘å¬
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RaftRegistry      â”‚
â”‚ WatchService()     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ è½¬å‘åˆ° mem.WatchService()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  memoryRegistry    â”‚
â”‚ WatchService()     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ å¦‚æœ svcIndex > lastIndex: ç«‹å³è¿”å›
     â”‚ å¦åˆ™: åˆ›å»ºé€šé“ï¼ŒåŠ å…¥ watchers åˆ—è¡¨
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç­‰å¾…å˜æ›´æˆ–è¶…æ—¶     â”‚
â”‚ select {           â”‚
â”‚   case <-ch:       â”‚ # æœåŠ¡å˜æ›´
â”‚   case <-timeout:  â”‚ # 30s è¶…æ—¶
â”‚ }                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ ListHealthyInstances()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›å®ä¾‹åˆ—è¡¨       â”‚
â”‚ X-Index: 105       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 TTL è¿‡æœŸæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Leader èŠ‚ç‚¹       â”‚
â”‚  TTL Expirer       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ æ¯ç§’è§¦å‘ Ticker
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  memoryRegistry    â”‚
â”‚ expireOnce()       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 1. æ‰«ææ‰€æœ‰ TTL æ£€æŸ¥
     â”‚ 2. åˆ¤æ–­æ˜¯å¦è¶…æ—¶ (now - LastPass > TTL)
     â”‚ 3. æ ‡è®°ä¸º critical
     â”‚ 4. æ¨è¿›æœåŠ¡ç´¢å¼•
     â”‚ 5. å”¤é†’ watchers
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç­‰å¾…ä¸­çš„å®¢æˆ·ç«¯     â”‚
â”‚  æ”¶åˆ°å˜æ›´é€šçŸ¥       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. å¹¶å‘ä¸é”ç­–ç•¥

### 12.1 è¯»å†™é”

**memoryRegistry**ï¼š
```go
mu sync.RWMutex

// è¯»æ“ä½œ - å…±äº«é”
func (m *memoryRegistry) ListHealthyInstances(...) {
    m.mu.RLock()
    defer m.mu.RUnlock()
    // è¯»å– instances, checks
}

// å†™æ“ä½œ - æ’ä»–é”
func (m *memoryRegistry) RegisterInstance(...) {
    m.mu.Lock()
    defer m.mu.Unlock()
    // ä¿®æ”¹ instances, checks, index
}
```

**ä¼˜åŠ¿**ï¼š
- è¯»æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œæé«˜æŸ¥è¯¢ååé‡
- å†™æ“ä½œä¸²è¡Œï¼Œä¿è¯ç´¢å¼•å•è°ƒé€’å¢

### 12.2 å¿«ç…§å¹¶å‘

**raftFSM.Snapshot()**ï¼š
```go
f.mu.Lock()         // FSM å¿«ç…§é”
defer f.mu.Unlock()

f.mem.mu.RLock()    // å†…å­˜åªè¯»é”
defer f.mem.mu.RUnlock()

// å¤åˆ¶æ•°æ®åˆ°å¿«ç…§
```

**è®¾è®¡è¦ç‚¹**ï¼š
- å¿«ç…§æœŸé—´å…è®¸è¯»æ“ä½œ
- å¿«ç…§æœŸé—´é˜»æ­¢å†™æ“ä½œï¼ˆé€šè¿‡ FSM é”ï¼‰
- é¿å…å¿«ç…§æ•°æ®ä¸ä¸€è‡´

### 12.3 Watchers ç”Ÿå‘½å‘¨æœŸ

**åˆ›å»º**ï¼š
```go
ch := make(chan struct{}, 1)  // å¸¦ç¼“å†²ï¼Œé¿å…é˜»å¡é€šçŸ¥
m.watchers[svc] = append(m.watchers[svc], ch)
```

**è§¦å‘**ï¼š
```go
for _, ch := range m.watchers[svc] {
    select {
    case ch <- struct{}{}:  // å°è¯•å‘é€
    default:                // å·²é€šçŸ¥è¿‡ï¼Œè·³è¿‡
    }
    close(ch)               // å…³é—­é€šé“ï¼Œé€šçŸ¥å®¢æˆ·ç«¯
}
m.watchers[svc] = nil       // æ¸…ç©ºåˆ—è¡¨
```

**ä¼˜åŠ¿**ï¼š
- è¾¹ç¼˜è§¦å‘ï¼Œé¿å…é‡å¤é€šçŸ¥
- å…³é—­é€šé“é‡Šæ”¾èµ„æºï¼Œé¿å…æ³„æ¼
- å®¢æˆ·ç«¯å–æ¶ˆååœ¨ä¸‹æ¬¡å˜æ›´æ—¶æ¸…ç†

---

## 13. éƒ¨ç½²æ‹“æ‰‘

### 13.1 å•æœºæˆ¿éƒ¨ç½²ï¼ˆæ¨èï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Datacenter 1                  â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Node1  â”‚  â”‚  Node2  â”‚  â”‚  Node3  â”‚ â”‚
â”‚  â”‚ Leader  â”‚  â”‚Follower â”‚  â”‚Follower â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Service Hosts (with Agents)  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- 3-5 èŠ‚ç‚¹ Raft é›†ç¾¤
- å¼ºä¸€è‡´æ€§ï¼Œç§’çº§æ•…éšœæ¢å¤
- Agents éƒ¨ç½²åœ¨æœåŠ¡ä¸»æœºä¸Š

### 13.2 è·¨æœºæˆ¿éƒ¨ç½²ï¼ˆæœªæ¥ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Datacenter 1   â”‚         â”‚   Datacenter 2   â”‚
â”‚   (Primary)      â”‚         â”‚   (Standby)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  Async  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Raft Clusterâ”‚â—„â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚ Raft Clusterâ”‚ â”‚
â”‚  â”‚  3 nodes    â”‚ â”‚ Repl    â”‚  â”‚  3 nodes    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼š
- æ¯ä¸ªæœºæˆ¿ç‹¬ç«‹ Raft é›†ç¾¤
- å¼‚æ­¥å¤åˆ¶ï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰
- å°±è¿‘è¯»å–ï¼Œé™ä½å»¶è¿Ÿ

---

## 14. å¯è§‚æµ‹æ€§

### 14.1 æ—¥å¿—

**å½“å‰å®ç°**ï¼ˆM2ï¼‰ï¼š
- è¯·æ±‚æ—¥å¿—ï¼š`[Method] [Path] [Duration]`
- æ³¨å†Œæ—¥å¿—ï¼š`Registered: ns/service/id`
- Raft æ—¥å¿—ï¼šhashicorp/raft å†…ç½®æ—¥å¿—

**è§„åˆ’**ï¼ˆM3ï¼‰ï¼š
- ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSONï¼‰
- æ—¥å¿—çº§åˆ«æ§åˆ¶ï¼ˆDEBUG/INFO/WARN/ERRORï¼‰
- å…³é”®æ“ä½œå®¡è®¡ï¼ˆæ³¨å†Œ/æ³¨é”€ï¼‰

### 14.2 æŒ‡æ ‡ï¼ˆM3 è§„åˆ’ï¼‰

**Prometheus æŒ‡æ ‡**ï¼š
```
# æ³¨å†Œè¡¨æŒ‡æ ‡
sider_registry_instances_total{namespace="default",service="api"}
sider_registry_checks_total{status="passing"}
sider_registry_index

# Raft æŒ‡æ ‡
sider_raft_leader{node="node1"}
sider_raft_commit_index
sider_raft_last_log_index

# HTTP æŒ‡æ ‡
sider_http_requests_total{path="/v1/health/service/api",status="200"}
sider_http_request_duration_seconds

# Watch æŒ‡æ ‡
sider_watchers_active{service="api"}
```

### 14.3 åˆ†å¸ƒå¼è¿½è¸ªï¼ˆM3 è§„åˆ’ï¼‰

- OpenTelemetry é›†æˆ
- è¿½è¸ªæ³¨å†Œâ†’å¤åˆ¶â†’æŸ¥è¯¢å…¨é“¾è·¯
- å…³è”è¯·æ±‚ ID

---

## 15. å®‰å…¨æœºåˆ¶

### 15.1 å½“å‰çŠ¶æ€ï¼ˆM2ï¼‰

- âŒ æ— è®¤è¯
- âŒ æ— åŠ å¯†
- âŒ æ—  ACL

### 15.2 è§„åˆ’ï¼ˆM3ï¼‰

#### mTLS
- Raft èŠ‚ç‚¹é—´ mTLS
- Agent â†” Server mTLS
- è‡ªåŠ¨è¯ä¹¦è½®æ¢

#### ACL/RBAC
```
Token: <jwt-token>
Permissions:
  - namespace: "default"
    services: ["api", "web"]
    actions: ["read", "write"]
```

#### å®¡è®¡æ—¥å¿—
- è®°å½•æ‰€æœ‰å†™æ“ä½œ
- åŒ…å«ç”¨æˆ·èº«ä»½ã€æ“ä½œç±»å‹ã€æ—¶é—´æˆ³

---

## 16. æ€§èƒ½ä¸å¯æ‰©å±•æ€§

### 16.1 æ€§èƒ½æŒ‡æ ‡ï¼ˆé¢„æœŸï¼‰

| æŒ‡æ ‡ | ç›®æ ‡ | å¤‡æ³¨ |
|------|------|------|
| æ³¨å†Œ TPS | 1000+ | å• Leader |
| æŸ¥è¯¢ QPS | 10000+ | å¤šèŠ‚ç‚¹å¹¶å‘è¯» |
| é•¿è½®è¯¢å¹¶å‘ | 10000+ | å†…å­˜å ç”¨ < 1GB |
| TTL ç»­çº¦å»¶è¿Ÿ | < 10ms | æœ¬åœ°å†…å­˜æ“ä½œ |
| Leader é€‰ä¸¾æ—¶é—´ | 1-3s | hashicorp/raft é»˜è®¤é…ç½® |

### 16.2 å¯æ‰©å±•æ€§

**å‚ç›´æ‰©å±•**ï¼š
- å¢åŠ  CPU/å†…å­˜ï¼Œæé«˜å•èŠ‚ç‚¹æ€§èƒ½
- é€‚ç”¨äºæœåŠ¡æ•° < 10000 çš„åœºæ™¯

**æ°´å¹³æ‰©å±•**ï¼š
- å¢åŠ  Follower èŠ‚ç‚¹ï¼Œåˆ†æ‹…è¯»è´Ÿè½½
- å¼•å…¥é™ˆæ—§è¯»ï¼ˆstale=trueï¼‰ï¼Œé™ä½ Leader å‹åŠ›

**åˆ†ç‰‡**ï¼ˆM4ï¼‰ï¼š
- æŒ‰ Namespace åˆ†ç‰‡ï¼Œå¤šä¸ªç‹¬ç«‹é›†ç¾¤
- æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰é›†æˆ

### 16.3 ç“¶é¢ˆä¸ä¼˜åŒ–

**ç“¶é¢ˆ**ï¼š
1. Leader å†™å…¥ååé‡å— Raft å¤åˆ¶å»¶è¿Ÿé™åˆ¶
2. Watch é£æš´ï¼ˆçƒ­ç‚¹æœåŠ¡é¢‘ç¹å˜æ›´ï¼‰
3. TTL è¿‡æœŸæ‰«æï¼ˆO(n) å¤æ‚åº¦ï¼‰

**ä¼˜åŒ–æ–¹å‘**ï¼š
1. Batch å†™å…¥ï¼ˆæ‰¹é‡æ³¨å†Œï¼‰
2. äº‹ä»¶èšåˆ/å»æŠ–ï¼ˆé˜²æŠ–åŠ¨ï¼‰
3. å¢é‡å¿«ç…§ï¼ˆä»…è®°å½•å˜æ›´ï¼‰
4. checkID â†’ svcKey ç´¢å¼•ï¼ˆåŠ é€ŸæŸ¥æ‰¾ï¼‰

---

## 17. æµ‹è¯•ç­–ç•¥

### 17.1 å•å…ƒæµ‹è¯•

**memoryRegistry**ï¼š
- æ³¨å†Œ/æ³¨é”€/æŸ¥è¯¢
- ç´¢å¼•æ¨è¿›
- TTL ç»­çº¦ä¸è¿‡æœŸ
- Watch è§¦å‘
- å¥åº·èšåˆ

**raftFSM**ï¼š
- å‘½ä»¤åº”ç”¨
- å¿«ç…§åˆ›å»ºä¸æ¢å¤
- é”™è¯¯å¤„ç†

**raftcmd**ï¼š
- å‘½ä»¤æ„å»ºä¸è§£æ
- ç¼–è§£ç æ­£ç¡®æ€§

### 17.2 é›†æˆæµ‹è¯•

**å•èŠ‚ç‚¹**ï¼š
- å¯åŠ¨ server
- Agent æ³¨å†ŒæœåŠ¡
- æŸ¥è¯¢å¥åº·å®ä¾‹
- åœæ­¢ Agentï¼ŒéªŒè¯ TTL è¿‡æœŸ

**å¤šèŠ‚ç‚¹**ï¼š
- å¯åŠ¨ 3 èŠ‚ç‚¹é›†ç¾¤
- æ³¨å†Œåˆ° Leader
- Follower æŸ¥è¯¢ä¸€è‡´æ€§
- åœæ­¢ Leaderï¼ŒéªŒè¯é€‰ä¸¾
- æ–° Leader ç»§ç»­æä¾›æœåŠ¡

### 17.3 æ€§èƒ½æµ‹è¯•

**è´Ÿè½½åœºæ™¯**ï¼š
- 1000 æœåŠ¡ Ã— 10 å®ä¾‹ = 10000 å®ä¾‹
- 10000 å¹¶å‘é•¿è½®è¯¢
- 1000 TPS æ³¨å†Œ/æ³¨é”€
- 10000 TPS TTL ç»­çº¦

**æµ‹è¯•å·¥å…·**ï¼š
- `wrk` / `hey`ï¼šHTTP å‹æµ‹
- è‡ªå®šä¹‰è„šæœ¬ï¼šæ¨¡æ‹Ÿ Agent è¡Œä¸º

---

## 18. è·¯çº¿å›¾

### M1ï¼ˆå·²å®Œæˆï¼‰
- âœ… å†…å­˜æ³¨å†Œè¡¨
- âœ… HTTP API
- âœ… Agentï¼ˆTTLã€HTTPã€TCPã€Cmd æ£€æŸ¥ï¼‰
- âœ… é•¿è½®è¯¢

### M2ï¼ˆå½“å‰ï¼‰
- âœ… Raft å…±è¯†ï¼ˆhashicorp/raftï¼‰
- âœ… æŒä¹…åŒ–ï¼ˆBoltDB + å¿«ç…§ï¼‰
- âœ… é›†ç¾¤ç®¡ç†ï¼ˆjoin/removeï¼‰
- âœ… Leader TTL è¿‡æœŸ
- âœ… ä»£ç é‡æ„ï¼ˆraftcmdã€raftregã€raftfsm åˆ†ç¦»ï¼‰

### M3ï¼ˆè§„åˆ’ä¸­ï¼‰
- ğŸ”² DNS æ¥å£ï¼ˆA/SRV è®°å½•ï¼‰
- ğŸ”² ACL/mTLS
- ğŸ”² Prometheus æŒ‡æ ‡
- ğŸ”² CLI å·¥å…·
- ğŸ”² Web UI
- ğŸ”² é™ˆæ—§è¯»ï¼ˆstale=trueï¼‰

### M4ï¼ˆè¿œæœŸï¼‰
- ğŸ”² è·¨æœºæˆ¿å¤åˆ¶
- ğŸ”² äº‹ä»¶èšåˆ/å»æŠ–
- ğŸ”² å¢é‡å¿«ç…§
- ğŸ”² å¤‡ä»½/æ¢å¤
- ğŸ”² å¤šç§Ÿæˆ·é…é¢

---

## é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­ | å«ä¹‰ |
|------|------|
| Namespace | å‘½åç©ºé—´ï¼Œé€»è¾‘éš”ç¦»å•å…ƒ |
| Service | æœåŠ¡åï¼ŒåŒä¸€æœåŠ¡å¯æœ‰å¤šä¸ªå®ä¾‹ |
| Instance | æœåŠ¡å®ä¾‹ï¼Œå”¯ä¸€æ ‡è¯†ä¸º ns/service/id |
| Check | å¥åº·æ£€æŸ¥ï¼Œå¯é™„åŠ åˆ°å®ä¾‹ä¸Š |
| TTL | Time To Liveï¼Œå¿ƒè·³è¶…æ—¶æ—¶é—´ |
| ModifyIndex | ä¿®æ”¹ç´¢å¼•ï¼Œå…¨å±€å•è°ƒé€’å¢ |
| Watch | ç›‘å¬æœåŠ¡å˜æ›´ï¼Œé˜»å¡ç­‰å¾… |
| Leader | Raft é›†ç¾¤ä¸»èŠ‚ç‚¹ï¼Œå¤„ç†æ‰€æœ‰å†™è¯·æ±‚ |
| Follower | Raft é›†ç¾¤ä»èŠ‚ç‚¹ï¼Œæ¥æ”¶æ—¥å¿—å¤åˆ¶ |
| FSM | Finite State Machineï¼Œæœ‰é™çŠ¶æ€æœº |
| WAL | Write-Ahead Logï¼Œé¢„å†™æ—¥å¿— |

### B. å‚è€ƒèµ„æ–™

- [Consul å®˜æ–¹æ–‡æ¡£](https://www.consul.io/docs)
- [hashicorp/raft](https://github.com/hashicorp/raft)
- [Raft è®ºæ–‡](https://raft.github.io/raft.pdf)
- [æœåŠ¡å‘ç°æœ€ä½³å®è·µ](https://microservices.io/patterns/service-registry.html)

### C. æºç å¯¼èˆª

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® | è¡Œå· |
|------|----------|------|
| æ•°æ®æ¨¡å‹ | `internal/registry/types.go` | 1-89 |
| Registry æ¥å£ | `internal/registry/registry.go` | 1-50 |
| å†…å­˜å®ç° | `internal/registry/memory.go` | 1-442 |
| Raft å‘½ä»¤ | `internal/registry/raftcmd.go` | 1-181 |
| Raft å°è£… | `internal/registry/raftreg.go` | 1-135 |
| Raft FSM | `internal/registry/raftfsm.go` | 1-238 |
| HTTP API | `internal/api/http.go` | 1-304 |
| æœåŠ¡ç«¯è£…é… | `internal/server/server.go` | 1-68 |
| é›†ç¾¤ç®¡ç† | `internal/server/cluster.go` | 1-71 |
| Agent | `internal/agent/agent.go` | 1-500+ |

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0
**æœ€åæ›´æ–°**ï¼š2025-01-15
**ç»´æŠ¤è€…**ï¼šSider Team
